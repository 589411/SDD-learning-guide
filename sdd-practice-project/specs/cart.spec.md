# 購物車功能規格

> **⚠️ 練習專案：此規格供學習者練習使用**  
> 學習者需要根據此規格撰寫測試和實作程式碼

## 功能概述

本規格定義電商網站的購物車功能，包括商品加入、數量調整、商品移除、價格計算等核心操作。

## 使用者故事 (User Story)

### US-002: 購物車管理

**身為**一個潛在買家，  
**我想要**將商品加入購物車並管理購物車內容，  
**以便於**在結帳前彈性調整我要購買的商品。

**商業價值：** 提升轉換率，降低購物流程摩擦  
**優先級：** 🔴 高（核心功能）  
**預估工時：** 12 小時

---

## 驗收條件 (Acceptance Criteria)

### ✅ 場景一：加入商品到購物車

```gherkin
Given 我的購物車是空的
When 我將商品 "iPhone 15" 加入購物車
  And 商品單價是 30000 元
  And 數量是 1
Then 購物車應該包含 1 個商品
  And 商品名稱應該是 "iPhone 15"
  And 商品數量應該是 1
  And 商品小計應該是 30000 元
  And 購物車總金額應該是 30000 元
```

**驗證重點：**
- 能成功加入商品到空購物車
- 正確記錄商品資訊（名稱、價格、數量）
- 正確計算小計和總金額

---

### ➕ 場景二：增加相同商品的數量

```gherkin
Given 我的購物車已經有 "iPhone 15" 1 個（單價 30000 元）
When 我再次加入 "iPhone 15" 2 個
Then 購物車應該仍然只有 1 種商品
  And "iPhone 15" 的數量應該是 3
  And "iPhone 15" 的小計應該是 90000 元
  And 購物車總金額應該是 90000 元
```

**驗證重點：**
- 相同商品不重複新增，而是累加數量
- 數量變更後重新計算金額

---

### 🛍️ 場景三：加入多種不同商品

```gherkin
Given 我的購物車已經有 "iPhone 15" 1 個（單價 30000 元）
When 我加入 "AirPods Pro" 2 個（單價 7000 元）
  And 我加入 "MacBook Pro" 1 個（單價 50000 元）
Then 購物車應該有 3 種商品
  And 購物車總金額應該是 94000 元（30000 + 14000 + 50000）
```

**驗證重點：**
- 支援多種不同商品
- 正確計算多商品總金額

---

### 🔢 場景四：調整商品數量

```gherkin
Given 我的購物車有 "iPhone 15" 3 個（單價 30000 元）
When 我將 "iPhone 15" 的數量改為 5
Then "iPhone 15" 的數量應該是 5
  And "iPhone 15" 的小計應該是 150000 元
  And 購物車總金額應該更新為 150000 元

Given 我的購物車有 "iPhone 15" 5 個
When 我將 "iPhone 15" 的數量減為 1
Then "iPhone 15" 的數量應該是 1
  And 購物車總金額應該是 30000 元
```

**驗證重點：**
- 支援增加數量
- 支援減少數量
- 數量變更後自動重算金額

---

### 🗑️ 場景五：移除商品

```gherkin
Given 我的購物車有以下商品：
  | 商品名稱 | 數量 | 單價 |
  | iPhone 15 | 2 | 30000 |
  | AirPods Pro | 1 | 7000 |
When 我移除 "AirPods Pro"
Then 購物車應該只剩 1 種商品
  And 購物車總金額應該是 60000 元

When 我移除 "iPhone 15"
Then 購物車應該是空的
  And 購物車總金額應該是 0 元
```

**驗證重點：**
- 能成功移除指定商品
- 移除後重新計算總金額
- 購物車可以清空

---

### ⚠️ 場景六：數量為 0 時自動移除

```gherkin
Given 我的購物車有 "iPhone 15" 3 個
When 我將數量調整為 0
Then "iPhone 15" 應該從購物車中移除
  And 購物車應該是空的
```

**驗證重點：**
- 數量設為 0 時自動移除商品

---

### 📭 場景七：輸入驗證

```gherkin
# 負數數量
Given 我嘗試加入 "iPhone 15" -1 個
Then 應該返回錯誤 "商品數量必須大於 0"
  And 購物車不應該有任何變更

# 非整數數量
Given 我嘗試加入 "iPhone 15" 1.5 個
Then 應該返回錯誤 "商品數量必須是整數"

# 商品 ID 為空
Given 我嘗試加入商品但未提供商品 ID
Then 應該返回錯誤 "請提供商品資訊"

# 超過庫存
Given "iPhone 15" 的庫存只有 5 個
When 我嘗試加入 10 個
Then 應該返回錯誤 "商品數量超過庫存限制"
  And 最多只能加入 5 個
```

**驗證重點：**
- 驗證數量必須是正整數
- 驗證商品資訊完整性
- 檢查庫存限制

---

### 🔢 場景八：計算邏輯

```gherkin
Given 我的購物車有以下商品：
  | 商品名稱 | 數量 | 單價 |
  | iPhone 15 | 2 | 30000 |
  | AirPods Pro | 3 | 7000 |
  | Magic Mouse | 1 | 2500 |
Then 商品總數應該是 6 個（2 + 3 + 1）
  And 商品種類應該是 3 種
  And 購物車總金額應該是 83500 元（60000 + 21000 + 2500）
```

**驗證重點：**
- 正確計算商品總數
- 正確計算商品種類
- 正確計算總金額

---

### 🧹 場景九：清空購物車

```gherkin
Given 我的購物車有 3 種商品，總金額 100000 元
When 我執行清空購物車
Then 購物車應該是空的
  And 商品總數應該是 0
  And 購物車總金額應該是 0 元
```

**驗證重點：**
- 能一次清空所有商品
- 清空後所有計算值歸零

---

## 技術規格

### 資料結構

```javascript
// 購物車物件
{
  items: [
    {
      id: "prod_001",
      name: "iPhone 15",
      price: 30000,
      quantity: 2,
      subtotal: 60000
    }
  ],
  totalItems: 2,        // 總數量
  totalProducts: 1,     // 商品種類數
  totalAmount: 60000    // 總金額
}

// 商品物件
{
  id: "prod_001",
  name: "iPhone 15",
  price: 30000,
  stock: 100
}
```

### API 介面（參考）

```javascript
// 建立購物車
const cart = createCart();

// 加入商品
cart.addItem(product, quantity);

// 更新數量
cart.updateQuantity(productId, quantity);

// 移除商品
cart.removeItem(productId);

// 清空購物車
cart.clear();

// 取得購物車資訊
cart.getItems();
cart.getTotalAmount();
cart.getTotalItems();
cart.isEmpty();
```

---

## 實作要求

### 必須實作的函數

1. **createCart()** - 建立新購物車
2. **addItem(product, quantity)** - 加入商品
3. **updateQuantity(productId, quantity)** - 更新數量
4. **removeItem(productId)** - 移除商品
5. **clear()** - 清空購物車
6. **getTotalAmount()** - 取得總金額
7. **getTotalItems()** - 取得商品總數
8. **getItems()** - 取得所有商品
9. **isEmpty()** - 檢查是否為空

### 輔助函數（建議）

1. **calculateSubtotal(price, quantity)** - 計算小計
2. **findItem(productId)** - 查找商品
3. **validateQuantity(quantity)** - 驗證數量
4. **validateProduct(product)** - 驗證商品資訊

---

## 測試檢查清單

### 基本功能
- [ ] 建立空購物車
- [ ] 加入第一個商品
- [ ] 加入相同商品（累加數量）
- [ ] 加入不同商品
- [ ] 更新商品數量
- [ ] 移除商品
- [ ] 清空購物車

### 計算邏輯
- [ ] 正確計算商品小計
- [ ] 正確計算購物車總金額
- [ ] 正確計算商品總數
- [ ] 正確計算商品種類數

### 邊界情況
- [ ] 空購物車的各種操作
- [ ] 數量為 0 時的處理
- [ ] 最大數量限制
- [ ] 非常大的金額計算
- [ ] 浮點數精度問題

### 錯誤處理
- [ ] 負數數量
- [ ] 非整數數量
- [ ] 空的商品資訊
- [ ] 不存在的商品 ID
- [ ] 超過庫存限制

### 資料完整性
- [ ] 每次操作後資料一致性
- [ ] 購物車狀態正確更新
- [ ] 計算結果準確無誤

---

## 學習建議

### 步驟 1：理解規格
仔細閱讀每個場景，理解業務邏輯

### 步驟 2：撰寫測試
根據場景撰寫 Jest 測試案例

### 步驟 3：紅燈階段
執行測試，確認全部失敗（這是正常的）

### 步驟 4：實作功能
撰寫程式碼讓測試通過

### 步驟 5：綠燈階段
所有測試通過

### 步驟 6：重構
改善程式碼品質，保持測試通過

---

## 進階挑戰

完成基本功能後，可以嘗試：

1. **優惠券功能** - 支援折扣碼
2. **運費計算** - 根據金額計算運費
3. **商品限購** - 每種商品限購數量
4. **購物車持久化** - 儲存到 localStorage
5. **購物車合併** - 登入後合併訪客購物車
6. **商品推薦** - 根據購物車內容推薦相關商品

---

## 參考資源

- [Jest 官方文件](https://jestjs.io/)
- [TDD 實踐指南](https://martinfowler.com/bliki/TestDrivenDevelopment.html)
- [E-commerce Cart Best Practices](https://baymard.com/blog/cart-abandonment)

---

## 完成標準

- ✅ 所有場景的測試都通過
- ✅ 測試覆蓋率達到 90% 以上
- ✅ 程式碼遵循 Clean Code 原則
- ✅ 適當的錯誤處理
- ✅ 清楚的程式碼註解
